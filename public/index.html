<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABB机器人3D可视化系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #2c3e50);
            color: #ecf0f1;
            overflow: hidden;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .error-message {
            background: #e74c3c;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 10px;
            text-align: center;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo h1 {
            margin-left: 10px;
            font-size: 1.8rem;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status {
            display: flex;
            align-items: center;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #2ecc71;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .robot-container {
            flex: 3;
            position: relative;
        }

        #robotCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .controls {
            flex: 1;
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-group {
            margin-bottom: 25px;
        }

        .control-group h3 {
            margin-bottom: 15px;
            color: #3498db;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 8px;
        }

        .joint-control {
            margin-bottom: 15px;
        }

        .joint-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .joint-value {
            color: #2ecc71;
            font-weight: bold;
        }

        .slider-container {
            display: flex;
            align-items: center;
        }

        .slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }

        .data-panel {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .data-row:last-child {
            border-bottom: none;
        }

        footer {
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 20px;
            text-align: center;
            font-size: 0.9rem;
            color: #95a5a6;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }

        .connection-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #e74c3c;
            margin-right: 8px;
        }

        .connected .connection-dot {
            background-color: #2ecc71;
        }

        .view-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
        }

        .view-btn {
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .view-btn:hover {
            background: rgba(52, 152, 219, 0.7);
        }

        .progress-bar {
            width: 300px;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            margin-top: 20px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: #3498db;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="#3498db" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <path d="M2 17L12 22L22 17" stroke="#3498db" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <path d="M2 12L12 17L22 12" stroke="#3498db" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
                <h1>ABB机器人3D可视化系统</h1>
            </div>
            <div class="status">
                <div class="status-indicator"></div>
                <span>系统运行中</span>
            </div>
        </header>

        <div class="main-content">
            <div class="robot-container">
                <div class="loading-overlay" id="loadingOverlay">
                    <div class="spinner"></div>
                    <div>正在加载3D场景...</div>
                    <div id="loadStatus">初始化中</div>
                    <div class="progress-bar">
                        <div class="progress" id="loadProgress"></div>
                    </div>
                </div>
                <canvas id="robotCanvas"></canvas>
                <div class="view-controls">
                    <button class="view-btn" id="frontView">前视图</button>
                    <button class="view-btn" id="sideView">侧视图</button>
                    <button class="view-btn" id="topView">俯视图</button>
                    <button class="view-btn" id="resetView">重置视图</button>
                </div>
            </div>

            <div class="controls">
                <div class="control-group">
                    <h3>关节控制</h3>

                    <div class="joint-control">
                        <div class="joint-label">
                            <span>关节 1 (底座旋转)</span>
                            <span class="joint-value" id="joint1Value">0.00°</span>
                        </div>
                        <div class="slider-container">
                            <input type="range" min="-120" max="220" value="0" class="slider" id="joint1Slider">
                        </div>
                    </div>

                    <div class="joint-control">
                        <div class="joint-label">
                            <span>关节 2 (下臂)</span>
                            <span class="joint-value" id="joint2Value">0.00°</span>
                        </div>
                        <div class="slider-container">
                            <input type="range" min="-90" max="90" value="0" class="slider" id="joint2Slider">
                        </div>
                    </div>

                    <div class="joint-control">
                        <div class="joint-label">
                            <span>关节 3 (上臂)</span>
                            <span class="joint-value" id="joint3Value">0.00°</span>
                        </div>
                        <div class="slider-container">
                            <input type="range" min="-90" max="90" value="0" class="slider" id="joint3Slider">
                        </div>
                    </div>

                    <div class="joint-control">
                        <div class="joint-label">
                            <span>关节 4 (手腕旋转)</span>
                            <span class="joint-value" id="joint4Value">0.00°</span>
                        </div>
                        <div class="slider-container">
                            <input type="range" min="-180" max="180" value="0" class="slider" id="joint4Slider">
                        </div>
                    </div>

                    <div class="joint-control">
                        <div class="joint-label">
                            <span>关节 5 (手腕弯曲)</span>
                            <span class="joint-value" id="joint5Value">0.00°</span>
                        </div>
                        <div class="slider-container">
                            <input type="range" min="-90" max="90" value="0" class="slider" id="joint5Slider">
                        </div>
                    </div>

                    <div class="joint-control">
                        <div class="joint-label">
                            <span>关节 6 (末端旋转)</span>
                            <span class="joint-value" id="joint6Value">0.00°</span>
                        </div>
                        <div class="slider-container">
                            <input type="range" min="-400" max="400" value="0" class="slider" id="joint6Slider">
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>实时数据</h3>
                    <div class="data-panel">
                        <div class="data-row">
                            <span>数据源:</span>
                            <span id="dataSource">PLC实时数据</span>
                        </div>
                        <div class="data-row">
                            <span>更新时间:</span>
                            <span id="updateTime">--:--:--</span>
                        </div>
                        <div class="data-row">
                            <span>通信状态:</span>
                            <span id="commStatus" class="connection-status">
                                <span class="connection-dot"></span>
                                <span>未连接</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>ABB机器人3D可视化系统 &copy; 2025 | 基于Three.js和Node.js开发</p>
            <div class="connection-status" id="serverStatus">
                <span class="connection-dot"></span>
                <span>服务器连接中...</span>
            </div>
        </footer>
    </div>

    <script src="/libs/fflate/umd/index.js"></script>
    <script src="/libs/three/build/three.min.js"></script>
    <script src="/libs/three/examples/js/controls/OrbitControls.js"></script>
    <script src="/libs/three/examples/js/loaders/FBXLoader.js"></script>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>

    <script>
        // 初始化Three.js场景
        let scene, camera, renderer, controls;
        let robotModel = null;
        let joints = {
            joint1: 0, // 底座旋转
            joint2: 0, // 下臂
            joint3: 0, // 上臂
            joint4: 0, // 手腕旋转
            joint5: 0, // 手腕弯曲
            joint6: 0  // 末端旋转
        };

        // 检查Three.js是否加载完成
        function isThreeLoaded() {
            return typeof THREE !== 'undefined' &&
                typeof THREE.OrbitControls !== 'undefined' &&
                typeof THREE.FBXLoader !== 'undefined';
        }

        // 等待Three.js加载完成
        function waitForThree(callback) {
            const maxAttempts = 50;
            let attempts = 0;

            function checkThree() {
                if (isThreeLoaded()) {
                    callback();
                } else if (attempts < maxAttempts) {
                    attempts++;
                    setTimeout(checkThree, 100);
                } else {
                    console.error("Three.js加载超时");
                    document.getElementById('loadStatus').textContent = "Three.js加载失败，请刷新页面";
                }
            }

            checkThree();
        }

        // 初始化场景
        function init() {
            // 创建场景
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a2530);

            // 创建相机
            const canvas = document.getElementById('robotCanvas');
            camera = new THREE.PerspectiveCamera(45, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            camera.position.set(-5, 2, 5);
            camera.lookAt(0, 1, 0);

            // 创建渲染器
            renderer = new THREE.WebGLRenderer({
                canvas: canvas,
                antialias: true,
                alpha: true
            });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            // 安全地初始化轨道控制
            try {
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.screenSpacePanning = false;
                controls.minDistance = 1;
                controls.maxDistance = 20;
                controls.maxPolarAngle = Math.PI;
            } catch (error) {
                console.error("初始化OrbitControls失败:", error);
                document.getElementById('loadStatus').textContent = "控制器初始化失败，使用基本视图控制";
                // 创建简单的替代控制方案
                createSimpleControls();
            }

            // 添加灯光
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 7);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);

            // 添加点光源作为补充
            const pointLight = new THREE.PointLight(0x3498db, 0.5, 100);
            pointLight.position.set(0, 5, 5);
            scene.add(pointLight);

            // 添加网格地面
            const gridHelper = new THREE.GridHelper(10, 10, 0x444444, 0x222222);
            scene.add(gridHelper);

            // 创建坐标系
            const axesHelper = new THREE.AxesHelper(2);
            scene.add(axesHelper);

            // 窗口大小调整事件
            window.addEventListener('resize', onWindowResize);

            // 视图控制按钮
            document.getElementById('frontView').addEventListener('click', () => setCameraView(0, 2, 8));
            document.getElementById('sideView').addEventListener('click', () => setCameraView(8, 2, 0));
            document.getElementById('topView').addEventListener('click', () => setCameraView(0, 8, 2));
            document.getElementById('resetView').addEventListener('click', () => {
                setCameraView(0, 2, 8);
                if (controls && controls.reset) {
                    controls.reset();
                }
            });

            // 关节滑块控制
            for (let i = 1; i <= 6; i++) {
                document.getElementById(`joint${i}Slider`).addEventListener('input', (e) => {
                    const value = parseFloat(e.target.value);
                    joints[`joint${i}`] = value;
                    document.getElementById(`joint${i}Value`).textContent = value.toFixed(2) + '°';
                    updateRobot();
                });
            }

            // 启动动画循环
            animate();

            // 连接WebSocket
            connectWebSocket();

            // 加载FBX模型
            loadFBXModel();
        }

        // 创建简单的替代控制方案
        function createSimpleControls() {
            let isMouseDown = false;
            let previousMousePosition = { x: 0, y: 0 };
            const canvas = document.getElementById('robotCanvas');

            canvas.addEventListener('mousedown', (e) => {
                isMouseDown = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });

            canvas.addEventListener('mouseup', () => {
                isMouseDown = false;
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!isMouseDown) return;

                const deltaMove = {
                    x: e.clientX - previousMousePosition.x,
                    y: e.clientY - previousMousePosition.y
                };

                // 旋转相机
                camera.position.x -= deltaMove.x * 0.01;
                camera.position.y += deltaMove.y * 0.01;
                camera.lookAt(0, 1, 0);

                previousMousePosition = { x: e.clientX, y: e.clientY };
            });

            // 鼠标滚轮缩放
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                const zoomSpeed = 0.1;
                const delta = e.deltaY * zoomSpeed;

                camera.position.z += delta;
                if (camera.position.z < 3) camera.position.z = 3;
                if (camera.position.z > 20) camera.position.z = 20;

                camera.lookAt(0, 1, 0);
            });
        }

        // 加载FBX模型
        function loadFBXModel() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadStatus = document.getElementById('loadStatus');
            const loadProgress = document.getElementById('loadProgress');

            // 显示加载界面
            loadingOverlay.style.display = 'flex';
            loadStatus.textContent = '正在加载FBX模型...';
            loadProgress.style.width = '0%';

            // 模拟加载进度
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress > 90) progress = 90;
                loadProgress.style.width = progress + '%';
                loadStatus.textContent = `已加载 ${Math.round(progress)}%`;
            }, 200);

            try {
                const loader = new THREE.FBXLoader();

                loader.load(
                    // 尝试多个可能的路径
                    '/irb_120_object.fbx', // 主要路径
                    function (object) {
                        clearInterval(progressInterval);

                        // 成功加载
                        if (robotModel) {
                            scene.remove(robotModel);
                        }
                        robotModel = object;
                        scene.add(robotModel);

                        // 设置模型位置和缩放
                        robotModel.position.set(0, 0, 0);
                        robotModel.scale.set(0.01, 0.01, 0.01);

                        // 遍历模型查找关节
                        setupFBXJoints(robotModel);

                        console.log("FBX机器人模型加载成功");

                        // 更新加载状态
                        loadStatus.textContent = '模型加载完成!';
                        loadProgress.style.width = '100%';

                        // 延迟隐藏加载界面，让用户看到完成状态
                        setTimeout(() => {
                            loadingOverlay.style.display = 'none';
                        }, 1000);
                    },
                    function (xhr) {
                        // 加载进度
                        const percent = (xhr.loaded / xhr.total * 100);
                        console.log(percent + '% loaded');
                        loadStatus.textContent = `已加载 ${percent.toFixed(2)}%`;
                        loadProgress.style.width = percent + '%';
                    },
                    function (error) {
                        clearInterval(progressInterval);

                        // 加载失败 - 只使用FBX模型，不创建程序化模型
                        console.error('FBX模型加载失败:', error);
                        loadStatus.textContent = 'FBX模型加载失败，请检查文件路径';
                        loadProgress.style.width = '100%';

                        // 显示错误信息
                        setTimeout(() => {
                            loadingOverlay.innerHTML = `
                                <div class="error-message">
                                    <h3>FBX模型加载失败</h3>
                                    <p>请确保FBX文件位于正确位置：public/irb_120_object.fbx</p>
                                    <p>错误详情：${error.message || '未知错误'}</p>
                                    <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">重新加载</button>
                                </div>
                            `;
                        }, 1000);
                    }
                );
            } catch (error) {
                clearInterval(progressInterval);
                console.error('FBXLoader初始化失败:', error);
                loadStatus.textContent = '模型加载器初始化失败';
                loadProgress.style.width = '100%';

                setTimeout(() => {
                    loadingOverlay.innerHTML = `
                        <div class="error-message">
                            <h3>FBXLoader初始化失败</h3>
                            <p>错误详情：${error.message || '未知错误'}</p>
                            <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">重新加载</button>
                        </div>
                    `;
                }, 1000);
            }
        }

        // 设置FBX模型的关节
        function setupFBXJoints(model) {
            console.log("开始设置FBX关节...");

            // 重置关节映射
            window.jointMap = {};
            let jointsFound = 0;

            model.traverse(function (child) {
                const name = child.name;

                // 根据确切的关节名称识别
                if (name.includes("IRB_Link1")) {
                    child.userData.isJoint = 1;
                    window.jointMap[1] = child;
                    jointsFound++;
                    console.log(">>> 识别为关节1: IRB_Link1");
                } else if (name.includes("IRB_Link2")) {
                    child.userData.isJoint = 2;
                    window.jointMap[2] = child;
                    jointsFound++;
                    console.log(">>> 识别为关节2: IRB_Link2");
                } else if (name.includes("IRB_Link3")) {
                    child.userData.isJoint = 3;
                    window.jointMap[3] = child;
                    jointsFound++;
                    console.log(">>> 识别为关节3: IRB_Link3");
                } else if (name.includes("IRB_Link4")) {
                    child.userData.isJoint = 4;
                    window.jointMap[4] = child;
                    jointsFound++;
                    console.log(">>> 识别为关节4: IRB_Link4");
                } else if (name.includes("IRB_Link5")) {
                    child.userData.isJoint = 5;
                    window.jointMap[5] = child;
                    jointsFound++;
                    console.log(">>> 识别为关节5: IRB_Link5");
                } else if (name.includes("IRB_Link6")) {
                    child.userData.isJoint = 6;
                    window.jointMap[6] = child;
                    jointsFound++;
                    console.log(">>> 识别为关节6: IRB_Link6");
                }
            });

            console.log(`关节映射完成: 找到了 ${jointsFound} 个关节`, window.jointMap);

            // 如果没有找到关节，尝试备用方案
            if (jointsFound === 0) {
                console.log("未找到标准关节名称，尝试备用识别方案...");
                setupFBXJointsBackup(model);
            }
        }

        // 备用关节识别方案
        function setupFBXJointsBackup(model) {
            let index = 1;
            model.traverse(function (child) {
                // 寻找可能是关节的节点（有子节点或名称包含特定关键词）
                if (child.children.length > 0 ||
                    child.name.toLowerCase().includes('link') ||
                    child.name.toLowerCase().includes('arm') ||
                    child.name.toLowerCase().includes('wrist')) {

                    if (index <= 6) {
                        child.userData.isJoint = index;
                        window.jointMap[index] = child;
                        console.log(`备用方案: 节点 "${child.name}" 识别为关节 ${index}`);
                        index++;
                    }
                }
            });
        }

        // 更新机器人关节位置
        function updateRobot() {
            if (!robotModel) {
                console.log("机器人模型未加载");
                return;
            }

            console.log("更新关节角度:", joints);
            let jointsUpdated = 0;

            // 使用关节映射更新
            if (window.jointMap) {
                for (let i = 1; i <= 6; i++) {
                    if (window.jointMap[i]) {
                        applyJointRotation(window.jointMap[i], i, joints[`joint${i}`]);
                        jointsUpdated++;
                    }
                }
            }

            // 备用方案：遍历模型
            if (jointsUpdated === 0) {
                console.log("使用备用更新方案...");
                robotModel.traverse(function (child) {
                    if (child.userData && child.userData.isJoint) {
                        const jointNum = child.userData.isJoint;
                        applyJointRotation(child, jointNum, joints[`joint${jointNum}`]);
                        jointsUpdated++;
                    }
                });
            }

            console.log(`成功更新了 ${jointsUpdated} 个关节`);

            // 强制渲染更新
            if (controls && controls.update) {
                controls.update();
            }
        }

        // 应用关节旋转的辅助函数
        function applyJointRotation(joint, jointNum, angle) {
            const rad = THREE.MathUtils.degToRad(angle);

            console.log(`应用旋转: 关节 ${jointNum} (${joint.name}) 设置为 ${angle}°`);

            // 根据ABB机器人典型关节配置设置旋转轴
            switch (jointNum) {
                case 1: // 底座旋转 - 通常绕z轴
                    joint.rotation.z = rad;
                    break;
                case 2: // 下臂 - 通常绕Y轴
                    joint.rotation.y = rad;
                    break;
                case 3: // 上臂 - 通常绕x轴
                    joint.rotation.y = rad;
                    break;
                case 4: // 手腕旋转 - 通常绕x轴
                    joint.rotation.x = rad;
                    break;
                case 5: // 手腕弯曲 - 通常绕y轴
                    joint.rotation.y = rad;
                    break;
                case 6: // 末端旋转 - 通常绕x轴
                    joint.rotation.x = rad;
                    break;
                default:
                    console.warn(`未知关节 ${jointNum}`);
            }
        }

        // 设置相机视图
        function setCameraView(x, y, z) {
            camera.position.set(x, y, z);
            camera.lookAt(0, 1, 0);
            if (controls && controls.update) {
                controls.update();
            }
        }

        // 窗口大小调整处理
        function onWindowResize() {
            const canvas = document.getElementById('robotCanvas');
            camera.aspect = canvas.clientWidth / canvas.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        }

        // 动画循环
        function animate() {
            requestAnimationFrame(animate);
            if (controls && controls.update) {
                controls.update();
            }
            renderer.render(scene, camera);
        }

        // 连接WebSocket接收实时数据
        function connectWebSocket() {
            const socket = io();

            socket.on('connect', () => {
                console.log('已连接到服务器');
                document.getElementById('serverStatus').classList.add('connected');
                document.getElementById('serverStatus').querySelector('span:last-child').textContent = '已连接服务器';
            });

            socket.on('disconnect', () => {
                console.log('与服务器断开连接');
                document.getElementById('serverStatus').classList.remove('connected');
                document.getElementById('serverStatus').querySelector('span:last-child').textContent = '服务器连接断开';
            });

            socket.on('connectionStatus', (data) => {
                document.getElementById('commStatus').classList.toggle('connected', data.plcConnected);
                document.getElementById('commStatus').querySelector('span:last-child').textContent =
                    data.plcConnected ? 'PLC已连接' : 'PLC未连接';
            });

            socket.on('robotData', (data) => {
                // 更新关节数据
                joints.joint1 = data.joint1 || 0;
                joints.joint2 = data.joint2 || 0;
                joints.joint3 = data.joint3 || 0;
                joints.joint4 = data.joint4 || 0;
                joints.joint5 = data.joint5 || 0;
                joints.joint6 = data.joint6 || 0;

                // 更新UI显示
                for (let i = 1; i <= 6; i++) {
                    const value = joints[`joint${i}`];
                    document.getElementById(`joint${i}Value`).textContent = value.toFixed(2) + '°';
                    document.getElementById(`joint${i}Slider`).value = value;
                }

                // 更新机器人模型
                updateRobot();

                // 更新数据面板
                document.getElementById('updateTime').textContent = new Date(data.timestamp).toLocaleTimeString();

                // 判断数据源 - 只显示PLC实时数据
                document.getElementById('dataSource').textContent = 'PLC实时数据';
                document.getElementById('commStatus').classList.toggle('connected', !data.isMockData);
                document.getElementById('commStatus').querySelector('span:last-child').textContent =
                    data.isMockData ? 'PLC未连接' : 'PLC已连接';
            });
        }

        // 页面加载完成后等待Three.js加载完成再初始化
        window.addEventListener('DOMContentLoaded', () => {
            waitForThree(init);
        });
    </script>
</body>

</html>